!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).proxyStorage={})}(this,(function(e){"use strict";let t=new WeakMap;function n(e,n,r){const o={ctx:this,fn:r};let c=t.get(e);c||t.set(e,c=new Map);const a=c.get(n);a?a.push(o):c.set(n,[o])}function r(e,n,r){if(void 0===n)return void t.set(e,new Map);let o=t.get(e);if(o){const e=o.get(n);if(e&&e.length>0){let t=[];r&&(t=e.filter((e=>!(e.fn===r||e.fn?.fn===r)))),o.set(n,t)}}}function o(e,n,...r){const o=t.get(e);if(o){const e=o.get(n);if(e){const[t,n]=r;e.forEach((e=>e.fn.call(e.ctx,t,n)))}}}const c=Array.isArray,a=e=>null!==e&&"object"==typeof e,s=e=>"string"==typeof e&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,i=e=>Object.prototype.toString.call(e),u=(e,t)=>!Object.is(e,t);function l(e){try{return JSON.parse(e)}catch(t){return e}}const f=Object.prototype.hasOwnProperty,p=(e,t)=>f.call(e,t);function y(e){return(0,eval)(e)}const g="proxy:",d=new WeakMap,h={storage:{},key:"",proxy:{}};let x=!0;function b(e,t){return function(){delete e[t]}}function k(e,t,...n){let r=`${h.key}.${t}`;c(e)&&s(t)&&(r=`${h.key}[${t}]`),o(h.storage,r,...n)}let v=!1;const w=function(){const e={};return["push","pop","shift","unshift","splice"].forEach((t=>{e[t]=function(...e){v=!0;const n=this.length,r=d.get(this)[t].apply(this,e);return this.length>n&&k(this,"length",this.length,n),v=!1,r}})),e}();function m(e,t,n){return c(e)&&p(w,t)?Reflect.get(w,t,n):Reflect.get(e,t,n)}function E(e){x=!1;let t=h.proxy.getExpires(h.key);h.proxy[h.key]=e,t&&h.proxy.setExpires(h.key,t),x=!0}function S(e,t,n,r){let o;c(e)&&!v&&(o=e.length);const a=e[t],i=c(e)&&s(t)?Number(t)<e.length:p(e,t),l=Reflect.set(e,t,n,r);return l&&u(n,a)&&(k(e,t,n,i?a:void 0),c(e)&&void 0!==o&&Number(t)>=o&&k(e,"length",e.length,o),E(e)),l}function $(e,t){const n=p(e,t),r=e[t],o=Reflect.deleteProperty(e,t);return o&&n&&(k(e,t,void 0,r),E(e)),o}function O(e,t){let n,r=e;try{r=l(e)}catch(e){}if(!a(r))return r;if(!(r.expires&&new Date(+r.expires).getTime()<=Date.now())){switch(r.type){case"Number":n=+r.value;break;case"BigInt":n=BigInt(r.value);break;case"Boolean":n="true"===r.value;break;case"Null":n=null;break;case"Undefined":n=void 0;break;case"Object":case"Array":n=function(e){const t=new Proxy(e,{get:m,set:S,deleteProperty:$});return d.set(t,e),t}(r.value);break;case"Set":n=new Set(r.value);break;case"Map":n=new Map(r.value);break;case"Date":n=new Date(r.value);break;case"RegExp":n=y(r.value);break;case"Function":n=y(`(function() { return ${r.value} })()`);break;default:n=r.value}return n}t()}function D(e,t){const n=i(e).slice(8,-1);let r={type:n,value:e};switch(t&&(r.expires=t),n){case"String":case"Number":case"BigInt":case"Boolean":case"Null":case"Undefined":case"Date":case"RegExp":case"Function":r.value=""+e;break;case"Object":case"Array":break;case"Set":case"Map":r.value=Array.from(e);break;default:throw new Error(`can't set "${n}" property.`)}return JSON.stringify(r)}function N(e,t,n,r){let o;if(o="[object Date]"===i(n)?n.getTime():(e=>"string"==typeof e)(n)?+n.padEnd(13,"0"):n,o<=Date.now())return void delete r[t];let c=r[t];return c?(c=d.get(c)||c,e[`proxy:${t}`]=D(c,""+o),new Date(o)):void 0}function P(e,t){const o={};return["clear","key"].forEach((t=>{o[t]=e[t].bind(e)})),o.getItem=function(n){return R(e,n,t)},o.removeItem=function(t){return V(e,t)},o.setItem=function(n,r){return M(e,n,r,t)},o.getExpires=function(t){return function(e,t){const n=`proxy:${t}`;if(!e[n])return;let r=l(e[n]);return!a(r)||!r.expires||+r.expires<=Date.now()?void 0:new Date(+r.expires)}(e,t)},o.removeExpires=function(n){return function(e,t,n){let r=n[t];r&&(r=d.get(r)||r,e[`proxy:${t}`]=D(r))}(e,n,t)},o.setExpires=function(n,r){return N(e,n,r,t)},o.off=function(t,n){r(e,t,n)},o.on=function(t,r){n(e,t,r)},o.once=function(t,o){!function(e,t,o){const c=this,a=(n,s)=>{r(e,t,a),o.call(c,n,s)};a.fn=o,n(e,t,a)}(e,t,o)},o}let j;function R(e,t,n){if(x&&(h.storage=e,h.key=t,h.proxy=n),j||(j=P(e,n)),p(j,t))return Reflect.get(j,t,n);if(!I(e,t))return;const r=`proxy:${t}`,o=e[r]||e[t];return o?O(o,b(e,r)):o}function M(e,t,n,r){const c=`proxy:${t}`;let a=O(e[c],b(e,c));a=d.get(a)||a;const s=D(n),i=Reflect.set(e,c,s,r);return i&&u(n,a)&&x&&o(e,t,n,a),i}function I(e,t){return e.hasOwnProperty(`proxy:${t}`)||(r=t,!(n=e).hasOwnProperty(r)&&r in n);var n,r}function V(e,t){const n=`proxy:${t}`,r=p(e,n);let c=O(e[n],b(e,n));c=d.get(c)||c;const a=Reflect.deleteProperty(e,n);return a&&r&&o(e,t,void 0,c),a}function A(e){return new Proxy(e,{get:R,set:M,has:I,deleteProperty:V})}const B=A(localStorage),T=A(sessionStorage);window.addEventListener("storage",(e=>{if(e.key&&e.key.startsWith(g)){let t=e.newValue,n=e.oldValue;e.newValue&&(t=O(e.newValue,b(localStorage,e.key)),a(t)&&(t=d.get(t)||t)),e.oldValue&&(n=O(e.oldValue,b(localStorage,e.key)),a(n)&&(n=d.get(n)||n)),o(localStorage,e.key.slice(g.length),t,n)}})),e.local=B,e.session=T,Object.defineProperty(e,"__esModule",{value:!0})}));
